<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Banana Dash 3D ğŸŒ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#0d0520;overflow:hidden;font-family:'Press Start 2P',monospace;}
  canvas{display:block;}
  #ui{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;
    padding:12px 18px;pointer-events:none;z-index:10;}
  .uib{background:#0009;border:2px solid #ffe94e88;border-radius:4px;
    padding:6px 12px;color:#fff;font-size:8px;line-height:2.2;}
  .val{color:#ffe94e;font-size:10px;}
  #hearts{font-size:12px;letter-spacing:2px;}
  #pups{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;pointer-events:none;z-index:10;}
  .pp{background:#0009;border:2px solid #fff3;border-radius:20px;
    padding:5px 10px;color:#fff;font-size:7px;display:flex;align-items:center;gap:5px;}
  .pp.on{border-color:#ffe94e;box-shadow:0 0 10px #ffe94e88;}
  .pb{width:44px;height:4px;background:#333;border-radius:3px;overflow:hidden;}
  .pf{height:100%;border-radius:3px;}
  #overlay{position:fixed;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;background:#000b;z-index:20;gap:16px;}
  #overlay.hid{display:none;}
  .ot{color:#ffe94e;font-size:20px;text-shadow:3px 3px #c47800,0 0 24px #ffe94eaa;text-align:center;}
  .os{color:#fff;font-size:8px;line-height:2.5;text-align:center;}
  .bl{animation:bl 1s step-end infinite;}
  @keyframes bl{50%{opacity:0;}}
  #vign{position:fixed;inset:0;pointer-events:none;z-index:15;opacity:0;
    box-shadow:inset 0 0 120px 60px #ff000088;transition:opacity 0.06s;}
  #flsh{position:fixed;inset:0;pointer-events:none;z-index:14;opacity:0;transition:opacity 0.08s;}
  #ftxt{position:fixed;top:32%;left:50%;transform:translate(-50%,-50%);
    pointer-events:none;z-index:16;text-align:center;font-size:18px;
    color:#ffe94e;text-shadow:3px 3px #c47800;opacity:0;transition:opacity 0.15s,transform 0.4s;}
  #spdtxt{position:fixed;top:10px;left:50%;transform:translateX(-50%);
    color:#ff9944;font-size:8px;opacity:0;pointer-events:none;z-index:10;transition:opacity 0.4s;}
  #cmb{position:fixed;top:48%;right:18px;color:#ffe94e;font-size:9px;
    pointer-events:none;z-index:10;opacity:0;text-shadow:2px 2px #c47800;transition:opacity 0.3s;}
  #hint{position:fixed;bottom:52px;left:50%;transform:translateX(-50%);
    color:#fff5;font-size:7px;text-align:center;pointer-events:none;z-index:10;}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="ui">
  <div class="uib">SCORE<br><span class="val" id="sd">0</span></div>
  <div class="uib" style="text-align:center">ğŸŒ <span class="val" id="bd">0</span><br><div id="hearts">â¤ï¸â¤ï¸â¤ï¸</div></div>
  <div class="uib" style="text-align:right">BEST<br><span class="val" id="bst">0</span></div>
</div>

<div id="spdtxt">âš¡ FASTER!</div>
<div id="cmb">ğŸŒ x<span id="cbc">0</span></div>

<div id="pups">
  <div class="pp" id="pp-speed">âš¡ BOOST <div class="pb"><div class="pf" id="pf-speed" style="background:#ff6644;width:0%"></div></div></div>
  <div class="pp" id="pp-shield">ğŸ›¡ï¸ SHIELD <div class="pb"><div class="pf" id="pf-shield" style="background:#44aaff;width:0%"></div></div></div>
  <div class="pp" id="pp-magnet">ğŸ§² MAGNET <div class="pb"><div class="pf" id="pf-magnet" style="background:#ffe94e;width:0%"></div></div></div>
</div>

<div id="vign"></div>
<div id="flsh"></div>
<div id="ftxt"></div>

<div id="overlay">
  <div class="ot" id="ot">ğŸŒ BANANA DASH 3D</div>
  <div class="os" id="os">
    â† â†’ ARROWS / A D â€” SWITCH LANES<br>
    SPACE / â†‘ â€” JUMP &nbsp;Â·&nbsp; DOUBLE JUMP!<br><br>
    POWERUPS: âš¡ SPEED &nbsp;ğŸ›¡ï¸ SHIELD &nbsp;ğŸ§² MAGNET<br>
    ENEMIES: GORILLAS &amp; BIRDS<br>
    3 LIVES Â· SHIELD ABSORBS 1 HIT<br><br>
    <span class="bl">PRESS SPACE OR TAP TO START</span>
  </div>
</div>
<div id="hint">â† â†’ LANES &nbsp;|&nbsp; SPACE JUMP &nbsp;|&nbsp; DOUBLE JUMP</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AC = new (window.AudioContext||window.webkitAudioContext)();
function tone(f,type,dur,vol=0.18,f2=null){
  try{
    const o=AC.createOscillator(),g=AC.createGain();
    o.connect(g);g.connect(AC.destination);
    o.type=type;o.frequency.setValueAtTime(f,AC.currentTime);
    if(f2)o.frequency.exponentialRampToValueAtTime(f2,AC.currentTime+dur);
    g.gain.setValueAtTime(vol,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+dur);
    o.start();o.stop(AC.currentTime+dur);
  }catch(e){}
}
const sfx={
  jump(dbl){tone(dbl?300:220,'square',0.12,0.18,dbl?650:440);},
  banana(){tone(523,'square',0.07,0.18);setTimeout(()=>tone(784,'square',0.1,0.18),70);},
  combo(n){tone(400+n*80,'square',0.15,0.22,600+n*100);},
  hit(){tone(220,'sawtooth',0.07,0.25,80);setTimeout(()=>tone(110,'sawtooth',0.12,0.25),90);},
  die(){[300,200,150,80].forEach((f,i)=>setTimeout(()=>tone(f,'sawtooth',0.15,0.25),i*80));},
  start(){[261,329,392,523].forEach((f,i)=>setTimeout(()=>tone(f,'square',0.1,0.18),i*75));},
  shieldpop(){tone(800,'sine',0.05,0.25,200);},
  faster(){tone(440,'square',0.08,0.18);setTimeout(()=>tone(660,'square',0.12,0.18),90);},
  pu(type){
    if(type==='speed'){[400,600,800].forEach((f,i)=>setTimeout(()=>tone(f,'sawtooth',0.1,0.18),i*55));}
    if(type==='shield'){tone(300,'sine',0.08,0.18,600);setTimeout(()=>tone(500,'sine',0.12,0.18),100);}
    if(type==='magnet'){[350,450,550,650].forEach((f,i)=>setTimeout(()=>tone(f,'triangle',0.1,0.14),i*60));}
  }
};
let bgTimer=null,bgNodes=[];
function startBg(){
  stopBg();
  const notes=[261,329,392,523,392,329];let s=0;
  (function tick(){
    try{
      const o=AC.createOscillator(),g=AC.createGain();
      o.connect(g);g.connect(AC.destination);
      o.type='triangle';o.frequency.value=notes[s++%notes.length];
      g.gain.setValueAtTime(0.04,AC.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+0.17);
      o.start();o.stop(AC.currentTime+0.17);bgNodes.push(o);
    }catch(e){}
    bgTimer=setTimeout(tick,155);
  })();
}
function stopBg(){
  if(bgTimer)clearTimeout(bgTimer);
  bgNodes.forEach(n=>{try{n.stop();}catch(e){}});
  bgNodes=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let W=innerWidth,H=innerHeight;
canvas.width=W;canvas.height=H;
window.addEventListener('resize',()=>{
  W=canvas.width=innerWidth;
  H=canvas.height=innerHeight;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3D PERSPECTIVE ENGINE (pure Canvas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Camera sits at (camX, CAM_Y, CAM_Z) looking toward -Z
const CAM_Y=4.2, CAM_Z=9.5, FOV=540;
let camX=0; // lerps to follow monkey

function proj(wx,wy,wz){
  const rx=wx-camX, ry=wy-CAM_Y, rz=wz-CAM_Z;
  if(rz>=0)return null;
  const s=FOV/(-rz);
  return{sx:W/2+rx*s, sy:H*0.52-ry*s, s, depth:-rz};
}

// Shake state
let shakeX=0,shakeY=0,shakeTtl=0,shakeAmt=0;
function doShake(amt=5,frames=14){shakeAmt=amt;shakeTtl=frames;}

// â”€â”€ Core primitive: filled quad â”€â”€
function quad(p0,p1,p2,p3,fill,stroke,lw=1){
  if(!p0||!p1||!p2||!p3)return;
  ctx.beginPath();
  ctx.moveTo(p0.sx,p0.sy);ctx.lineTo(p1.sx,p1.sy);
  ctx.lineTo(p2.sx,p2.sy);ctx.lineTo(p3.sx,p3.sy);
  ctx.closePath();
  if(fill){ctx.fillStyle=fill;ctx.fill();}
  if(stroke){ctx.strokeStyle=stroke;ctx.lineWidth=lw;ctx.stroke();}
}

// â”€â”€ Draw a 3D box by computing 8 projected corners â”€â”€
// cx,cy,cz = center; sw,sh,sd = half-extents; colors={top,front,left,right,outline}
function box3d(cx,cy,cz,sw,sh,sd,colors,alpha=1){
  // 8 corners: front=+z side, back=-z side (further from camera)
  const F=cz+sd, B=cz-sd;
  const T=cy+sh, Bo=cy-sh;
  const L=cx-sw, R=cx+sw;
  // Project all 8
  const ftl=proj(L,T,F),ftr=proj(R,T,F),fbr=proj(R,Bo,F),fbl=proj(L,Bo,F);
  const btl=proj(L,T,B),btr=proj(R,T,B),bbr=proj(R,Bo,B),bbl=proj(L,Bo,B);
  if(!ftl||!ftr||!fbr||!fbl)return;
  const prevAlpha=ctx.globalAlpha;
  ctx.globalAlpha=alpha;
  // Front face
  quad(fbl,fbr,ftr,ftl,colors.front,colors.outline);
  // Top face (if visible)
  if(btl&&btr) quad(ftl,ftr,btr,btl,colors.top,colors.outline);
  // Right face
  if(bbr) quad(ftr,fbr,bbr,btr,colors.right||colors.side,colors.outline);
  // Left face
  if(bbl) quad(ftl,fbl,bbl,btl,colors.left||colors.side,colors.outline);
  ctx.globalAlpha=prevAlpha;
}

// â”€â”€ Draw a vertical cylinder (approx with quads) â”€â”€
function cyl3d(cx,cy,cz,r,h,color,segs=8){
  const top=cy+h/2, bot=cy-h/2;
  // Draw back-to-front slices
  for(let i=0;i<segs;i++){
    const a0=(i/segs)*Math.PI*2, a1=((i+1)/segs)*Math.PI*2;
    const x0=cx+Math.cos(a0)*r, z0=cz+Math.sin(a0)*r;
    const x1=cx+Math.cos(a1)*r, z1=cz+Math.sin(a1)*r;
    const p0b=proj(x0,bot,z0),p1b=proj(x1,bot,z1);
    const p0t=proj(x0,top,z0),p1t=proj(x1,top,z1);
    if(!p0b||!p1b||!p0t||!p1t)continue;
    const shade=0.6+0.4*((Math.cos(a0)+1)/2);
    ctx.fillStyle=lerpColor(color,'#000000',1-shade);
    quad(p0b,p1b,p1t,p0t,ctx.fillStyle,null);
  }
}

// â”€â”€ Utility: lerp hex colors â”€â”€
function lerpColor(a,b,t){
  const ah=parseInt(a.slice(1),16),bh=parseInt(b.slice(1),16);
  const ar=(ah>>16)&0xff,ag=(ah>>8)&0xff,ab=ah&0xff;
  const br=(bh>>16)&0xff,bg=(bh>>8)&0xff,bb=bh&0xff;
  const r=Math.round(ar+(br-ar)*t);
  const g=Math.round(ag+(bg-ag)*t);
  const bl2=Math.round(ab+(bb-ab)*t);
  return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${bl2.toString(16).padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANE_W=2.2;
const LANES=[-LANE_W,0,LANE_W];
const BASE_SPEED=10;
const GRAVITY=24;
const GROUND_Y=0;
const MONKEY_H=1.5; // visual height
const SPAWN_Z=-62;
const DESPAWN_Z=14;
const PU_DUR={speed:6,shield:10,magnet:8};
const PU_TYPES=['speed','shield','magnet'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state='idle'; // idle playing dying dead
let score=0,best=0,bananas=0,lives=3;
let speed=BASE_SPEED,slowMo=1;
let lane=1,targetX=LANES[1];
let monkeyX=LANES[1],monkeyY=GROUND_Y;
let velY=0,onGround=true,jumps=0;
let hitCooldown=0,hitFlash=0;
let combo=0,lastMilestone=0;
let leanZ=0; // roll tween for lane switch
let squashY=1,squashXZ=1,armRaise=0;
let tNow=0; // accumulated game time

const pu={speed:{on:false,t:0},shield:{on:false,t:0},magnet:{on:false,t:0}};

// Object pools
const obstacles=[], enemies=[], bananaItems=[], powerups=[], particles=[];

// Spawn timers
let obsTimer=0,enemyTimer=0,banTimer=0,puTimer=0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(x,y,z,color,n=10,spd=4){
  for(let i=0;i<n;i++){
    particles.push({
      x,y,z,
      vx:(Math.random()-.5)*spd,
      vy:2+Math.random()*4,
      vz:(Math.random()-.5)*spd,
      color,life:1,size:0.16
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN FX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let vigTimer=null;
function doVignette(dur=400){
  const el=document.getElementById('vign');
  el.style.opacity='1';
  clearTimeout(vigTimer);vigTimer=setTimeout(()=>el.style.opacity='0',dur);
}
let flshTimer=null;
function doFlash(gold=false,dur=80){
  const el=document.getElementById('flsh');
  el.style.background=gold?'#ffe94e':'#ffffff';
  el.style.opacity='0.55';
  clearTimeout(flshTimer);flshTimer=setTimeout(()=>el.style.opacity='0',dur);
}
let ftTimer=null,ftMoveTimer=null;
function floatText(txt,color='#ffe94e'){
  const el=document.getElementById('ftxt');
  el.textContent=txt;el.style.color=color;
  el.style.transform='translate(-50%,-50%) scale(1.3)';
  el.style.opacity='1';
  clearTimeout(ftTimer);clearTimeout(ftMoveTimer);
  ftMoveTimer=setTimeout(()=>{
    el.style.transform='translate(-50%,-90%) scale(1)';
  },50);
  ftTimer=setTimeout(()=>el.style.opacity='0',750);
}
let spdTimer=null;
function showFaster(){
  const el=document.getElementById('spdtxt');
  el.style.opacity='1';sfx.faster();
  clearTimeout(spdTimer);spdTimer=setTimeout(()=>el.style.opacity='0',900);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  document.getElementById('sd').textContent=Math.floor(score);
  document.getElementById('bd').textContent=bananas;
  document.getElementById('bst').textContent=Math.floor(best);
  document.getElementById('hearts').textContent=
    'â¤ï¸'.repeat(Math.max(0,lives))+'ğŸ–¤'.repeat(Math.max(0,3-lives));
  const cmbEl=document.getElementById('cmb');
  if(combo>=2){cmbEl.style.opacity='1';document.getElementById('cbc').textContent=combo;}
  else cmbEl.style.opacity='0';
  PU_TYPES.forEach(t=>{
    const pill=document.getElementById('pp-'+t);
    const fill=document.getElementById('pf-'+t);
    if(pu[t].on){
      pill.classList.add('on');
      fill.style.width=(pu[t].t/PU_DUR[t]*100)+'%';
    }else{
      pill.classList.remove('on');
      fill.style.width='0%';
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();onAction();}
  if(e.code==='ArrowLeft'||e.code==='KeyA'){e.preventDefault();switchLane(-1);}
  if(e.code==='ArrowRight'||e.code==='KeyD'){e.preventDefault();switchLane(1);}
});
let tx=null,ty=null;
document.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  if(tx===null)return;
  const dx=e.changedTouches[0].clientX-tx, dy=e.changedTouches[0].clientY-ty;
  if(Math.abs(dy)>Math.abs(dx)&&dy<-25)onAction();
  else if(Math.abs(dx)>25){switchLane(dx<0?-1:1);}
  else onAction();
  tx=null;ty=null;
},{passive:true});

function onAction(){
  if(state==='idle'||state==='dead'){startGame();return;}
  if(state==='playing')doJump();
}
function switchLane(dir){
  if(state!=='playing')return;
  const nl=Math.max(0,Math.min(2,lane+dir));
  if(nl===lane)return;
  lane=nl;targetX=LANES[lane];leanZ=dir*0.38;
}
function doJump(){
  if(jumps>=2)return;
  sfx.jump(jumps===1);
  velY=jumps===0?10.5:8.5;
  onGround=false;jumps++;
  squashY=1.35;squashXZ=0.72;
  if(jumps===2)spawnParticles(monkeyX,monkeyY+0.8,4,0xaa55ff,8,3);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  AC.resume();
  clearAll();
  state='playing';slowMo=1;
  document.getElementById('overlay').classList.add('hid');
  sfx.start();setTimeout(startBg,370);
}

function clearAll(){
  [obstacles,enemies,bananaItems,powerups,particles].forEach(a=>a.length=0);
  score=0;bananas=0;lives=3;speed=BASE_SPEED;
  lane=1;targetX=LANES[1];monkeyX=LANES[1];monkeyY=GROUND_Y;
  velY=0;onGround=true;jumps=0;hitCooldown=0;hitFlash=0;
  combo=0;lastMilestone=0;leanZ=0;squashY=1;squashXZ=1;armRaise=0;tNow=0;
  obsTimer=0;enemyTimer=0;banTimer=0;puTimer=0;
  PU_TYPES.forEach(t=>{pu[t].on=false;pu[t].t=0;});
  camX=0;shakeTtl=0;
  updateHUD();
}

function loseLife(){
  if(hitCooldown>0)return;
  if(pu.shield.on){
    sfx.shieldpop();pu.shield.on=false;pu.shield.t=0;
    doFlash(false,100);doShake(6,10);
    floatText('ğŸ›¡ï¸ BLOCKED!','#44aaff');
    hitCooldown=60;updateHUD();return;
  }
  lives--;sfx.hit();hitCooldown=90;hitFlash=90;
  doShake(7,16);doVignette(500);doFlash(false,80);
  spawnParticles(monkeyX,monkeyY+0.8,4,0xff3366,16,5);
  updateHUD();
  if(lives<=0)triggerDeath();
}

function triggerDeath(){
  if(state==='dying'||state==='dead')return;
  state='dying';stopBg();sfx.die();
  doShake(10,25);doVignette(1200);
  let t=0;
  const spin=setInterval(()=>{
    slowMo=Math.max(0.15,slowMo-0.04);
    t+=0.14;
    leanZ+=0.22; // spin out
    monkeyY+=0.06;
    if(t>1.6){
      clearInterval(spin);
      if(score>best)best=score;
      state='dead';
      document.getElementById('ot').textContent='GAME OVER ğŸ’';
      document.getElementById('os').innerHTML=
        `SCORE: ${Math.floor(score)} &nbsp;|&nbsp; ğŸŒ ${bananas}<br>BEST: ${Math.floor(best)}<br><br><span class="bl">PRESS SPACE OR TAP</span>`;
      document.getElementById('overlay').classList.remove('hid');
      updateHUD();
    }
  },30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPAWN HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnObstacle(){
  const li=Math.floor(Math.random()*3);
  const roll=Math.random();
  let w,h,d;
  if(roll<0.45){w=0.85;h=1.9;d=0.7;}
  else if(roll<0.75){w=1.7;h=0.65;d=0.7;}
  else{w=0.85;h=1.15;d=0.7;}
  const colors=['#e03a5a','#ff6644','#4488ff'];
  const c=colors[Math.floor(Math.random()*3)];
  obstacles.push({x:LANES[li],y:h/2,z:SPAWN_Z,w,h,d,lane:li,color:c,
    colTop:lerpColor(c,'#ffffff',0.35),colSide:lerpColor(c,'#000000',0.25)});
}

function spawnEnemy(){
  const li=Math.floor(Math.random()*3);
  const isGorilla=Math.random()<0.5;
  enemies.push({
    x:LANES[li],y:isGorilla?0.55:1.3,z:SPAWN_Z,
    lane:li,isGorilla,
    patrolT:1.2+Math.random()*1.4,
    phase:Math.random()*Math.PI*2
  });
}

function spawnBanana(zOverride){
  const li=Math.floor(Math.random()*3);
  bananaItems.push({x:LANES[li],y:0.9,z:zOverride!==undefined?zOverride:SPAWN_Z,lane:li,taken:false,rot:Math.random()*Math.PI*2});
}

function spawnPowerup(){
  const type=PU_TYPES[Math.floor(Math.random()*3)];
  const li=Math.floor(Math.random()*3);
  powerups.push({x:LANES[li],y:1.1,z:SPAWN_Z,lane:li,type,taken:false,rot:0});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Sky gradient â”€â”€
function drawSky(){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0a0318');g.addColorStop(0.6,'#1a0a2e');g.addColorStop(1,'#2d1050');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
}

// â”€â”€ Stars â”€â”€
const STARS=Array.from({length:160},()=>({
  x:Math.random()*W,y:Math.random()*H*0.6,
  s:0.5+Math.random()*1.5,b:0.4+Math.random()*0.6
}));
function drawStars(){
  STARS.forEach(s=>{
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.s,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${s.b*(0.7+0.3*Math.sin(tNow*1.5+s.x))})`;
    ctx.fill();
  });
  // Moon
  ctx.beginPath();ctx.arc(W*0.12,H*0.12,H*0.055,0,Math.PI*2);
  ctx.fillStyle='#fff8dc';ctx.fill();
  ctx.beginPath();ctx.arc(W*0.12+H*0.016,H*0.12-H*0.008,H*0.048,0,Math.PI*2);
  ctx.fillStyle='#0d0318';ctx.fill();
}

// â”€â”€ Ground tiles â”€â”€
const TILE_COUNT=14, TILE_D=6;
let tileOffset=0;
function drawGround(){
  const trackW=LANE_W*3+0.4;
  for(let i=0;i<TILE_COUNT;i++){
    const tz=-(i*TILE_D)+((tileOffset)%TILE_D)-TILE_D;
    const even=(Math.abs(Math.floor((tz-tileOffset)/TILE_D)))%2===0;
    const col=even?'#2a1850':'#341e63';
    box3d(0,-0.25,tz, trackW/2,0.25,TILE_D/2,
      {top:even?'#3d2570':'#4a2e80',front:col,side:col,outline:'#1a0c36'});
    // Edge glow lines
    [-trackW/2-0.02,trackW/2+0.02].forEach(ex=>{
      box3d(ex,-0.08,tz, 0.06,0.06,TILE_D/2,
        {top:'#6633aa',front:'#5522aa',side:'#5522aa',outline:null});
    });
    // Lane dividers
    [-LANE_W/2,LANE_W/2].forEach(dx=>{
      box3d(dx,-0.04,tz,0.03,0.03,TILE_D/2,
        {top:'#4422aa',front:'#4422aa',side:'#4422aa',outline:null});
    });
  }
}

// â”€â”€ Trees â”€â”€
const TREE_SLOTS=[];
for(let i=0;i<10;i++){
  TREE_SLOTS.push({side:-1,baseZ:-i*7,yo:Math.random()*0.3});
  TREE_SLOTS.push({side:1,baseZ:-i*7,yo:Math.random()*0.3});
}
function drawTrees(){
  TREE_SLOTS.forEach(t=>{
    const tz=((t.baseZ+tileOffset*0.9)%(TREE_SLOTS.length/2*7))-5;
    const tx=t.side*6.2;
    cyl3d(tx,1.5,tz,0.28,3,'#3d2108');
    box3d(tx,4.2,tz,1.1,1.5,1.1,{top:'#1a4a1a',front:'#1e5a1e',side:'#174414',outline:'#0d2e0d'});
    box3d(tx,5.8,tz,0.8,1.3,0.8,{top:'#1e5a1e',front:'#226622',side:'#174414',outline:'#0d2e0d'});
  });
}

// â”€â”€ Temple pillars â”€â”€
const PILLAR_ZS=[-10,-28,-46,-64,-82];
function drawPillars(){
  PILLAR_ZS.forEach(pz=>{
    const tz=((pz+tileOffset*0.7)%90)-10;
    [-9,9].forEach(px=>{
      cyl3d(px,4.5,tz,0.45,9,'#3d2460');
    });
  });
}

// â”€â”€ Obstacle â”€â”€
function drawObstacle(o){
  box3d(o.x,o.y,o.z, o.w/2,o.h/2,o.d/2,
    {top:o.colTop,front:o.color,side:o.colSide,right:o.colSide,outline:'#1a0c36'});
}

// â”€â”€ Enemy (gorilla) â”€â”€
function drawGorilla(e){
  const bob=Math.abs(Math.sin(tNow*6+e.phase))*0.18;
  const by=e.y+bob;
  // Body
  box3d(e.x,by+0.55,e.z, 0.46,0.55,0.36,{top:'#9b1a33',front:'#cc2244',side:'#8a1530',outline:'#300'});
  // Head
  box3d(e.x,by+1.35,e.z, 0.36,0.3,0.3,{top:'#b01e3a',front:'#cc2244',side:'#8a1530',outline:'#300'});
  // Eyes (red glow)
  [-0.14,0.14].forEach(ex=>{
    const ep=proj(e.x+ex,by+1.42,e.z-0.32);
    if(ep){ctx.beginPath();ctx.arc(ep.sx,ep.sy,3,0,Math.PI*2);ctx.fillStyle='#ff2200';ctx.fill();}
  });
  // Arms
  box3d(e.x-0.55,by+0.3+Math.sin(tNow*6+e.phase)*0.1,e.z, 0.16,0.4,0.16,{top:'#9b1a33',front:'#cc2244',side:'#8a1530',outline:null});
  box3d(e.x+0.55,by+0.3-Math.sin(tNow*6+e.phase)*0.1,e.z, 0.16,0.4,0.16,{top:'#9b1a33',front:'#cc2244',side:'#8a1530',outline:null});
}

// â”€â”€ Enemy (bird) â”€â”€
function drawBird(e){
  const wave=Math.sin(tNow*5+e.phase)*0.35;
  const by=e.y+wave;
  const wingFlap=Math.sin(tNow*12+e.phase)*0.25;
  // Body (pointed cone-like box)
  box3d(e.x,by,e.z, 0.18,0.18,0.55,{top:'#dd1e44',front:'#ff2255',side:'#aa1530',outline:'#300'});
  // Wings
  box3d(e.x,by+wingFlap,e.z, 0.7,0.08,0.38,{top:'#cc1e3a',front:'#ff2255',side:'#aa1530',outline:null});
  // Eye
  const ep=proj(e.x+0.15,by+0.08,e.z-0.56);
  if(ep){ctx.beginPath();ctx.arc(ep.sx,ep.sy,2.5,0,Math.PI*2);ctx.fillStyle='#ffcc00';ctx.fill();}
}

// â”€â”€ Banana â”€â”€
function drawBanana(b){
  const r=b.rot;
  const bx=b.x+Math.sin(r)*0.15;
  box3d(bx,b.y,b.z, 0.09,0.3,0.09,
    {top:'#ffe94e',front:'#ffe94e',side:'#e8c800',outline:'#aa8800'});
  // Glow halo
  const p=proj(bx,b.y,b.z);
  if(p){
    ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*0.7,0,Math.PI*2);
    ctx.fillStyle='rgba(255,230,0,0.18)';ctx.fill();
  }
}

// â”€â”€ Powerup token â”€â”€
const PU_COLORS={speed:'#ff6644',shield:'#44aaff',magnet:'#ffe94e'};
function drawPowerup(pu_){
  const c=PU_COLORS[pu_.type];
  const bob=Math.sin(tNow*3+pu_.rot)*0.18;
  pu_.rot+=0.02;
  const spinX=pu_.x+Math.cos(pu_.rot)*0.3;
  box3d(spinX,pu_.y+bob,pu_.z, 0.32,0.32,0.32,
    {top:lerpColor(c,'#ffffff',0.4),front:c,side:lerpColor(c,'#000000',0.2),outline:'#ffffff44'});
  // Ring
  const p=proj(pu_.x,pu_.y+bob,pu_.z);
  if(p){
    ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*1.0,0,Math.PI*2);
    ctx.strokeStyle=c+'88';ctx.lineWidth=2;ctx.stroke();
  }
}

// â”€â”€ Shield bubble â”€â”€
function drawShield(){
  const p=proj(monkeyX,monkeyY+0.8,4);
  if(!p||!pu.shield.on)return;
  const pulse=1+0.08*Math.sin(tNow*8);
  ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*1.1*pulse,0,Math.PI*2);
  ctx.strokeStyle=`rgba(68,170,255,${0.5+0.2*Math.sin(tNow*8)})`;
  ctx.lineWidth=3;ctx.stroke();
  ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*1.1*pulse,0,Math.PI*2);
  ctx.fillStyle='rgba(68,170,255,0.1)';ctx.fill();
}

// â”€â”€ Magnet ring â”€â”€
function drawMagnetRing(){
  if(!pu.magnet.on)return;
  const p=proj(monkeyX,monkeyY+0.5,4);
  if(!p)return;
  ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*2.2,0,Math.PI*2);
  ctx.strokeStyle=`rgba(255,233,0,${0.3+0.15*Math.sin(tNow*6)})`;
  ctx.lineWidth=2;ctx.setLineDash([6,4]);ctx.stroke();ctx.setLineDash([]);
}

// â”€â”€ Speed trail â”€â”€
function drawSpeedTrail(){
  if(!pu.speed.on)return;
  for(let i=1;i<=4;i++){
    const tz=4+i*0.7;
    const alpha=(0.4-i*0.08);
    const p=proj(monkeyX,monkeyY+0.8,tz);
    if(!p)continue;
    ctx.beginPath();ctx.arc(p.sx,p.sy,p.s*(0.9-i*0.12),0,Math.PI*2);
    ctx.fillStyle=`rgba(255,100,30,${alpha})`;ctx.fill();
  }
}

// â”€â”€ Monkey â”€â”€
function drawMonkey(){
  const visible=hitCooldown===0||(Math.floor(hitCooldown/6)%2===0);
  if(!visible)return;
  const mx=monkeyX, my=monkeyY, mz=4;
  const sy=squashY, sxz=squashXZ;
  // Legs
  const legSwing=onGround?Math.sin(tNow*speed*0.8)*0.22:0.18;
  box3d(mx-0.18*sxz,(my+0.05+legSwing*0.3)*sy,mz, 0.13*sxz,0.28*sy,0.13*sxz,
    {top:'#7a4a15',front:'#7a4a15',side:'#5a3410',outline:null});
  box3d(mx+0.18*sxz,(my+0.05-legSwing*0.3)*sy,mz, 0.13*sxz,0.28*sy,0.13*sxz,
    {top:'#7a4a15',front:'#7a4a15',side:'#5a3410',outline:null});
  // Body
  box3d(mx,( my+0.55)*sy,mz, 0.37*sxz,0.42*sy,0.27*sxz,
    {top:'#d98a3a',front:'#c97c30',side:'#a86020',outline:'#6a3c12'});
  // Arms
  const armSwing=onGround?-Math.sin(tNow*speed*0.8)*0.2:(-0.5+armRaise);
  box3d(mx-0.52*sxz,(my+0.52+armSwing*0.25)*sy,mz, 0.12*sxz,0.3*sy,0.12*sxz,
    {top:'#d98a3a',front:'#c97c30',side:'#a86020',outline:null});
  box3d(mx+0.52*sxz,(my+0.52-armSwing*0.25)*sy,mz, 0.12*sxz,0.3*sy,0.12*sxz,
    {top:'#d98a3a',front:'#c97c30',side:'#a86020',outline:null});
  // Head
  box3d(mx,(my+1.15)*sy,mz, 0.34*sxz,0.31*sy,0.28*sxz,
    {top:'#d98a3a',front:'#c97c30',side:'#a86020',outline:'#6a3c12'});
  // Face plate
  box3d(mx,(my+1.1)*sy,mz-0.28, 0.23*sxz,0.2*sy,0.06,
    {top:'#f5c89a',front:'#f5c89a',side:'#e8b080',outline:null});
  // Eyes
  [-0.12,0.12].forEach(ex=>{
    const ep=proj(mx+ex*sxz,(my+1.18)*sy,mz-0.35);
    if(ep){ctx.beginPath();ctx.arc(ep.sx,ep.sy,2.5,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();}
    const ep2=proj(mx+ex*sxz,(my+1.18)*sy,mz-0.37);
    if(ep2){ctx.beginPath();ctx.arc(ep2.sx,ep2.sy,1.3,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();}
  });
  // Ears
  [-0.38,0.38].forEach(ex=>{
    box3d(mx+ex*sxz,(my+1.15)*sy,mz, 0.1*sxz,0.14*sy,0.1*sxz,
      {top:'#d98a3a',front:'#c97c30',side:'#a86020',outline:null});
  });
  // Tail
  box3d(mx+0.12*sxz,(my+0.35)*sy,mz+0.3, 0.07,0.28,0.07,
    {top:'#7a4a15',front:'#7a4a15',side:'#5a3410',outline:null});
}

// â”€â”€ Particles â”€â”€
function drawParticles(){
  particles.forEach(p=>{
    if(p.life<=0)return;
    const col=typeof p.color==='number'
      ?'#'+p.color.toString(16).padStart(6,'0')
      :p.color;
    const pp=proj(p.x,p.y,p.z);
    if(!pp)return;
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.fillStyle=col;
    const sz=pp.s*p.size*2;
    ctx.fillRect(pp.sx-sz/2,pp.sy-sz/2,sz,sz);
  });
  ctx.globalAlpha=1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTime=0;
function update(ts){
  const rawDt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;
  const dt=rawDt*slowMo;

  if(state==='playing'){
    tNow+=dt;
    score+=dt*35;
    const newSpeed=BASE_SPEED+score/320+(pu.speed.on?5:0);
    if(Math.floor(newSpeed/3)>Math.floor(speed/3)&&Math.floor(newSpeed)>lastMilestone){
      lastMilestone=Math.floor(newSpeed);showFaster();
    }
    speed=newSpeed;
    // Powerup timers
    PU_TYPES.forEach(t=>{
      if(pu[t].on){pu[t].t-=dt;if(pu[t].t<=0){pu[t].on=false;pu[t].t=0;}}
    });
  }else if(state==='idle'||state==='dying'||state==='dead'){
    tNow+=rawDt*0.5;
  }

  // â”€â”€ Track scroll â”€â”€
  const scrollZ=state==='playing'?speed*dt:0;
  tileOffset+=scrollZ;

  // â”€â”€ Camera X lerp â”€â”€
  camX+=(monkeyX*0.15-camX)*Math.min(1,dt*6);

  // â”€â”€ Shake â”€â”€
  if(shakeTtl>0){
    shakeTtl--;
    shakeX=(Math.random()-.5)*shakeAmt;
    shakeY=(Math.random()-.5)*shakeAmt*0.5;
  }else{shakeX=0;shakeY=0;}

  // â”€â”€ Monkey X â”€â”€
  monkeyX+=(targetX-monkeyX)*Math.min(1,dt*14);
  leanZ*=Math.pow(0.88,dt*60);

  // â”€â”€ Monkey Y â”€â”€
  if(state==='playing'||state==='dying'){
    monkeyY+=velY*dt;velY-=GRAVITY*dt;
    if(monkeyY<=GROUND_Y){
      if(!onGround&&velY<-3){squashY=0.68;squashXZ=1.32;}
      monkeyY=GROUND_Y;velY=0;onGround=true;jumps=0;
    }else onGround=false;
  }

  // â”€â”€ Squash ease â”€â”€
  squashY+=(1-squashY)*Math.min(1,dt*14);
  squashXZ+=(1-squashXZ)*Math.min(1,dt*14);
  armRaise*=Math.pow(0.8,dt*60);

  // â”€â”€ Hit cooldown â”€â”€
  if(hitCooldown>0)hitCooldown--;

  if(state!=='playing')return;

  // â”€â”€ Spawn â”€â”€
  obsTimer+=dt;enemyTimer+=dt;banTimer+=dt;puTimer+=dt;
  const obsInt=Math.max(0.5,1.3-score/4000);
  const enInt=Math.max(2.2,5-score/1200);
  if(obsTimer>obsInt){spawnObstacle();obsTimer=0;}
  if(enemyTimer>enInt){spawnEnemy();enemyTimer=0;}
  if(banTimer>0.7){spawnBanana();banTimer=0;}
  if(puTimer>Math.max(7,16-score/400)){spawnPowerup();puTimer=0;}

  // â”€â”€ Move obstacles â”€â”€
  for(let i=obstacles.length-1;i>=0;i--){
    const o=obstacles[i];
    o.z+=scrollZ;
    if(o.z>DESPAWN_Z){obstacles.splice(i,1);continue;}
    if(hitCooldown===0){
      const dx=Math.abs(monkeyX-o.x),dz=Math.abs(4-o.z);
      if(dx<0.38+o.w*0.42&&dz<0.8&&monkeyY<o.h+0.1){loseLife();break;}
    }
  }

  // â”€â”€ Move enemies â”€â”€
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.z+=scrollZ*(e.isGorilla?1:1.55);
    if(e.z>DESPAWN_Z){enemies.splice(i,1);continue;}
    if(e.isGorilla){
      e.patrolT-=dt;
      if(e.patrolT<=0){
        const choices=[];if(e.lane>0)choices.push(e.lane-1);if(e.lane<2)choices.push(e.lane+1);
        e.lane=choices[Math.floor(Math.random()*choices.length)];
        e.x+=(LANES[e.lane]-e.x); // snap (feels aggressive)
        e.patrolT=1.0+Math.random()*1.2;
      }
      e.y=0.55+Math.abs(Math.sin(tNow*6+e.phase))*0.15;
    }else{
      e.y=1.3+Math.sin(tNow*5+e.phase)*0.38;
    }
    if(hitCooldown===0){
      const dx=Math.abs(monkeyX-e.x),dz=Math.abs(4-e.z);
      const dy=Math.abs(monkeyY+0.8-e.y);
      if(dx<0.75&&dz<0.85&&dy<0.95){loseLife();break;}
    }
  }

  // â”€â”€ Move bananas â”€â”€
  for(let i=bananaItems.length-1;i>=0;i--){
    const b=bananaItems[i];
    b.z+=scrollZ;b.rot+=dt*3;
    if(pu.magnet.on&&!b.taken){
      const dx=monkeyX-b.x,dz=4-b.z,dy=monkeyY+0.5-b.y;
      const dist=Math.sqrt(dx*dx+dz*dz);
      if(dist<4){b.x+=dx*dt*9;b.z+=dz*dt*9;b.y+=dy*dt*9;}
    }
    if(b.z>DESPAWN_Z){bananaItems.splice(i,1);continue;}
    if(!b.taken){
      const dx=Math.abs(monkeyX-b.x),dz=Math.abs(4-b.z),dy=Math.abs(monkeyY+0.5-b.y);
      if(dx<0.9&&dz<0.9&&dy<1){
        b.taken=true;bananas++;score+=50;combo++;
        sfx.banana();doFlash(true,60);armRaise=1.1;
        spawnParticles(b.x,b.y,b.z,'#ffe94e',14,4);
        if(combo>=3){floatText(`ğŸŒ COMBO x${combo}!`,'#ffe94e');sfx.combo(Math.min(combo,6));}
        else floatText('+50','#ffe94e');
        bananaItems.splice(i,1);updateHUD();continue;
      }
    }
    if(!b.taken) combo=Math.min(combo,combo); // preserve combo until miss
  }
  // Reset combo if no banana was collected this frame... track with flag
  // (combo resets happen on hit, not on miss-pass â€” keeps it fair)

  // â”€â”€ Move powerups â”€â”€
  for(let i=powerups.length-1;i>=0;i--){
    const p=powerups[i];
    p.z+=scrollZ;
    if(p.z>DESPAWN_Z){powerups.splice(i,1);continue;}
    if(!p.taken){
      const dx=Math.abs(monkeyX-p.x),dz=Math.abs(4-p.z),dy=Math.abs(monkeyY+0.8-p.y);
      if(dx<1.05&&dz<1.05&&dy<1.1){
        p.taken=true;
        pu[p.type].on=true;pu[p.type].t=PU_DUR[p.type];
        sfx.pu(p.type);
        spawnParticles(p.x,p.y,p.z,
          p.type==='speed'?0xff6644:p.type==='shield'?0x44aaff:0xffe94e,18,5);
        doFlash(p.type!=='shield',100);
        const symbols={speed:'âš¡ SPEED BOOST!',shield:'ğŸ›¡ï¸ SHIELD UP!',magnet:'ğŸ§² MAGNET ON!'};
        const clrs={speed:'#ff6644',shield:'#44aaff',magnet:'#ffe94e'};
        floatText(symbols[p.type],clrs[p.type]);
        powerups.splice(i,1);updateHUD();continue;
      }
    }
  }

  // â”€â”€ Particles â”€â”€
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    if(p.life<=0){particles.splice(i,1);continue;}
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.z+=p.vz*dt;
    p.vy-=16*dt;p.life-=dt*1.6;
  }

  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” painter's algorithm by depth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


function render(){
  ctx.save();
  ctx.translate(shakeX,shakeY);

  drawSky();
  drawStars();
  drawPillars();
  drawTrees();
  drawGround();

  // Collect all 3D objects and sort back-to-front
  const drawList=[];
  obstacles.forEach(o=>drawList.push({z:o.z,fn:()=>drawObstacle(o)}));
  enemies.forEach(e=>drawList.push({z:e.z,fn:()=>e.isGorilla?drawGorilla(e):drawBird(e)}));
  bananaItems.forEach(b=>{if(!b.taken)drawList.push({z:b.z,fn:()=>drawBanana(b)});});
  powerups.forEach(p=>{if(!p.taken)drawList.push({z:p.z,fn:()=>drawPowerup(p)});});
  drawList.sort((a,b)=>a.z-b.z); // further first
  drawList.forEach(d=>d.fn());

  drawSpeedTrail();
  drawMagnetRing();
  drawShield();
  drawMonkey();
  drawParticles();

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  update(ts);
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>